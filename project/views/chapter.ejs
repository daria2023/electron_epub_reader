<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link href="/style.css" rel="stylesheet" type="text/css">

</head>
<body>
<header>
    <div class="chapter-nav">
        <a  href=<%= "/htmls/"+ encodeURIComponent(title) + '/'+ prevId%>>ä¸Šä¸€ç« </a>
        <a href="/">ğŸ“š</a>
        <a  href=<%= "/htmls/" + encodeURIComponent(title) + '/'+ nextId%>>ä¸‹ä¸€ç« </a>
    </div>
    <div class="chapter-style">
        <button id="style-set-btn">âš™ï¸</button>
        <button id="theme-set-btn">â˜€ï¸</button>
        <div id="style-controller" class="hide">
            <div>
                <label for="font-select">Choose a font:</label>
                <select name="font-family" id="font-select">
                    <option value="SimSun" selected>å®‹ä½“</option>
                    <option value="FangSong">ä»¿å®‹</option>
                    <option value="STZhongsong">åæ–‡ä¸­å®‹</option>
                    <option value="SimHei">é»‘ä½“</option>
                </select>
            </div>
            <div>
                <label for="size-select">Choose font size:</label>
                <select name="font-size" id="size-select">
                    <option value="0.5">0.5</option>
                    <option value="0.75">0.75</option>
                    <option value="1">1</option>
                    <option value="1.25">1.25</option>
                    <option value="1.5" selected>1.5</option>
                    <option value="1.75">1.75</option>
                    <option value="2">2</option>
                </select>
            </div>
            <div>
                <label for="line-height-select">Choose a line-height:</label>
                <select name="line-height" id="line-height-select">
                    <option value="1.15">1.15</option>
                    <option value="1.25">1.2</option>
                    <option value="1.5" selected>1.5</option>
                    <option value="1.75">1.75</option>
                    <option value="2">2</option>
                </select>
            </div>
        </div>
    </div>
</header>
<div id="chapter-content" chapter_id="<%= id %>">
    <%- content %>
</div>
<footer>
    <a  href=<%= "/htmls/"+ encodeURIComponent(title) + '/'+ prevId%>>ä¸Šä¸€ç« </a>
    <a href="/">ğŸ“š</a>
    <a  href=<%= "/htmls/" + encodeURIComponent(title) + '/'+ nextId%>>ä¸‹ä¸€ç« </a>
</footer>
<script src="../../index.js"></script>
<script>
 const themeBtn = document.getElementById('theme-set-btn');
   themeBtn.addEventListener('click',()=>{
       if(document.body.classList.contains('light')) {
           document.body.classList.remove('light');
           themeBtn.innerHTML = 'ğŸŒ™'
       } else {
           document.body.classList.add('light');
           themeBtn.innerHTML = 'â˜€ï¸'
       }
   })
    const styleEl = document.getElementById('style-controller');
    const styleSetBtn = document.getElementById('style-set-btn');
    styleSetBtn.addEventListener('click',()=>{
        styleEl.classList.toggle('hide');
    })

    const container = document.getElementById('chapter-content');
    const fontEl = document.getElementById('font-select');
    const sizeEl = document.getElementById('size-select');
    const lineHeightEl = document.getElementById('line-height-select');

    fontEl.addEventListener('change', e => {
        container.style.fontFamily = e.target.value;
    })
    sizeEl.addEventListener('change', e => {
        const ps = container.querySelectorAll('p')
        ps.forEach(p => {
            p.style.fontSize = e.target.value + 'rem';
        })
    })
    lineHeightEl.addEventListener('change', e=> {
        const ps = container.querySelectorAll('p')
        ps.forEach(p => {
            p.style.lineHeight = e.target.value;
        })
    })
    const handleSelect = () => {
        if(!document.getSelection().toString().trim()) return;
        const selected_txt_El = document.getSelection().anchorNode.parentElement;
        const selected_txt = document.getSelection().toString();
        const whole_txt = selected_txt_El.innerText;
        const segments = whole_txt.split(selected_txt);
        const newArray = [segments[0], selected_txt, segments[1]];
        if(segments.length === 1) {
            crossParagrah();
        } else {
            splitEl(selected_txt_El, newArray);
        }
        storeTxts(selected_txt);
    }

    const crossParagrah = () => {
        const newParagraph = document.createElement('p');
        const selectedRange = window.getSelection().getRangeAt(0);
        newParagraph.appendChild(selectedRange.cloneContents());
        selectedRange.startContainer.parentNode.innerHTML = '';
        selectedRange.endContainer.parentNode.innerHTML = '';
        selectedRange.startContainer.appendChild(newParagraph);
        selectedRange.startContainer.classList.add('selected');
    }

    const splitEl = (el, txts) => {
        if(!txts[0] && !txts[2]) {
           return el.classList.add('selected');
        }
        el.innerHTML = ''
        const start = document.createElement('span');
        start.innerHTML = txts[0] ?? '';
        const the_selected = document.createElement('span');
        the_selected.innerHTML = txts[1] ?? '';
        the_selected.classList.add('selected');
        const end = document.createElement('span');
        end.innerHTML = txts[2] ?? ''
        el.append(start,the_selected,end);
    }

    const storeTxts = async (txt)=>{
        const formData = new FormData();
        formData.append('title', document.title);
        formData.append('content', txt);

        const res = await fetch(`/notes`, {
            method: 'post',
            body: formData,
        })
    }
    document.addEventListener('mouseup',handleSelect);
</script>
<style>
    header {
        position: sticky;
        top: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 5px;
        background-color: #333;
    }
    .light header {
        background-color: var(--dark-theme-clr);
        color: var(--dark-theme-bg);
    }
    .selected {
        text-decoration: underline;
        text-decoration-color: #F3B664;
    }
    .light .selected {
        text-decoration: none;
        background-color: #F3B664;
    }
</style>
</body>
</html>